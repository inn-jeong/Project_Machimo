<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마취모: 마이페이지</title>
    <script type="text/javascript" src="/login/jquery.min.js" ></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
        .top_fragment,.bottom_fragment{
            display: block;
        }
        #wrapper{
            position:relative;
            min-width: 1200px;
        }
        #cnt{
            min-height: 1000px;
            position: relative;
        }
        #cnt .cnt_body{
            position: relative;
            padding-left: 320px;
            width: 1200px;
            margin: 0 auto;
        }
        h2.subtitle {
            padding: 30px 0 20px;
            font-size: 35px;
            font-weight: normal;
            text-align: center;
        }
        .my_menu{
            position: absolute;
            top: 0;
            width: 260px;
            margin-left: -320px;
        }
        .username{
            color: #fff;
            line-height: 1;
        }
        .username strong{
            font-size: 34px;
            font-weight: 500;
        }
        .usertitle{
            color: rgb(255,102,35) !important;
        }
        .order_list_subtitle{
            padding: 60px 0 20px 30px;
        }
        dl{
            padding-left: 20px;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <div class="top_fragment">
        <th:block th:replace="fragments/header"></th:block>
    </div>
    <div id="cnt">
        <header>
            <!--        <div class="mb-5 text-center">-->
            <!--            <h3>마이페이지</h3>-->
            <!--        </div>-->
            <h2 class="subtitle">마이페이지</h2>
        </header>

        <main>
            <div class="cnt_body">
                <div class="my_menu border">
                    <div class="mb-4 bg-dark py-5 text-center">
                        <p class="usertitle mb-3">프로필 정보</p>
                        <p class="username"><strong><span id="name" th:text="${session.user.uNickname}"></span></strong>님</p>
                        <!--                <p class="username">이름: <strong><span id="name" th:text="${session.user.uName}"></span></strong>님</p>-->
                        <!--                <p class="username">이메일: <strong><span id="email" th:text="${session.user.uEmail}"></span></strong></p>-->
                    </div>

                    <dl>
                        <dt>정보관리</dt>
                        <dd><a href="/mypage/modify">나의 정보수정</a></dd>
                        <dd>회원탈퇴</dd>
                    </dl>
                    <dl>
                        <dt>상품관리</dt>
                        <dd><a href="/basket/page">장바구니</a></dd>
                        <dd>관심상품</dd>
                        <dd><a href="/mypage/sales_list">판매내역</a></dd>
                    </dl>
                    <dl>
                        <dt>주문관리</dt>
                        <dd><a href="/mypage/order_list">주문내역</a></dd>
                        <dd>낙찰상품</dd>
                    </dl>
                    <dl class="pb-5">
                        <dt>활동관리</dt>
                        <dd>나의 문의내역</dd>
                        <dd>나의 상품후기</dd>
                    </dl>
                </div>
                <div th:if="${type.equals('main')}" class="order_list">
                    <input type="hidden" id="result_modify" th:value="${modify}">
                    <div class="order_list_subtitle">
                        <h4>최근 구매 내역</h4>
                    </div>
                    <table th:if="${items != null}" class="table table-hover mx-auto text-center" style="width: 1000px">
                        <thead>
                        <tr class="table-active">
                            <td>번호</td>
                            <th colspan="2">상품정보</th>
                            <th>주문일자</th>
                            <th>주문번호</th>
                            <th>주문금액</th>
                            <th colspan="2">주문상태</th>
                        </tr>
                        </thead>
                        <tbody th:each="item, count:${items}" th:id="${item.productId}" class="item-show">
                        <tr>
                            <td th:text="${count.count}" rowspan="3" style="width: 40px" class="align-middle"></td>
                            <td th:text="${item.iSubImg}" rowspan="3" style="width: 100px" class="align-middle"></td>
                            <td style="width: 200px; text-align: left">
                                <div th:switch="${item.pSaleType}">
                                    판매유형:
                                    <span th:case="0">경매</span>
                                    <span th:case="1">즉시판매</span>
                                </div>
                            </td>
                            <td th:text="${item.createdAt}" rowspan="3" style="width: 120px" class="align-middle"></td>
                            <td th:text="${item.orderId}" rowspan="3" style="width: 80px" class="align-middle"></td>
                            <td th:if="${item.pSaleType == 1}" rowspan="3" style="width: 100px" class="align-middle">즉시구매가<br><span th:text="${item.pDirect}"></span>원</td>
                            <td th:if="${item.pSaleType == 0}" rowspan="3" style="width: 100px" class="align-middle">낙찰가<br><span th:text="${item.pBPrice}"></span>원</td>
                            <td th:text="${item.orderStatus}" rowspan="3" style="width: 80px" class="align-middle"></td>
                            <td rowspan="3" style="width: 80px" class="align-middle"><button>후기작성</button></td>
                        </tr>
                        <tr>
                            <td th:text="${item.uName}" style="text-align: left"></td>
                        </tr>
                        <tr>
                            <td th:text="${item.pName}" style="text-align: left"></td>
                        </tr>
                        </tbody>
                    </table>
                    <div th:if="${items == null}" style="align-content: center">
                        최근 구매내역이 없습니다.
                    </div>
                </div>
                <div th:if="${type.equals('order')}" class="order_list">
                    <div class="order_list_subtitle">
                        <h4>구매 내역</h4>
                    </div>
                    <table th:if="${items != null}" class="table table-hover mx-auto text-center" style="width: 1000px">
                        <thead>
                        <tr class="table-active">
                            <td>번호</td>
                            <th colspan="2">상품정보</th>
                            <th>주문일자</th>
                            <th>주문번호</th>
                            <th>주문금액</th>
                            <th colspan="2">주문상태</th>
                        </tr>
                        </thead>
                        <tbody th:each="item, count:${items}" th:id="${item.productId}" class="item-show">
                        <tr>
                            <td th:text="${count.count}" rowspan="3" style="width: 40px" class="align-middle"></td>
                            <td th:text="${item.iSubImg}" rowspan="3" style="width: 100px" class="align-middle"></td>
                            <td style="width: 200px; text-align: left">
                                <div th:switch="${item.pSaleType}">
                                    판매유형:
                                    <span th:case="0">경매</span>
                                    <span th:case="1">즉시판매</span>
                                </div>
                            </td>
                            <td th:text="${item.createdAt}" rowspan="3" style="width: 120px" class="align-middle"></td>
                            <td th:text="${item.orderId}" rowspan="3" style="width: 80px" class="align-middle"></td>
<!--                            판매유형에 따른 가격 출력-->
                            <td th:if="${item.pSaleType == 1}" rowspan="3" style="width: 100px" class="align-middle">즉시구매가<br><span th:text="${item.pDirect}"></span>원</td>
                            <td th:if="${item.pSaleType == 0}" rowspan="3" style="width: 100px" class="align-middle">낙찰가<br><span th:text="${item.pBPrice}"></span>원</td>
                            <td th:text="${item.orderStatus}" rowspan="3" style="width: 80px" class="align-middle"></td>
                            <td rowspan="3" style="width: 80px" class="align-middle"><button>후기작성</button></td>
                        </tr>
                        <tr>
                            <td th:text="'판매자:'+${item.uName}" style="text-align: left"></td>
                        </tr>
                        <tr>
                            <td th:text="${item.pName}" style="text-align: left"></td>
                        </tr>
                        </tbody>
                    </table>
                    <div th:if="${items == null}" style="align-content: center">
                        구매내역이 없습니다.
                    </div>
                </div>
                <div th:if="${type.equals('sales')}" class="order_list">
                    <div class="order_list_subtitle">
                        <h4>판매 내역</h4>
                    </div>
                    <table th:if="${salesItems != null}" class="table table-hover mx-auto text-center" style="width: 1000px">
                        <thead>
                        <tr class="table-active">
                            <td>번호</td>
                            <th colspan="2">상품정보</th>
                            <th>제품코드</th>
                            <th>금액</th>
                            <th>판매시작일</th>
                            <th>주문상태</th>
                        </tr>
                        </thead>
                        <tbody th:each="item, count:${salesItems}" th:id="${item.productId}" class="item-show">
                        <tr>
                            <td th:text="${count.count}" rowspan="2" style="width: 40px" class="align-middle"></td>
                            <td th:text="${item.iSubImg}" rowspan="2" style="width: 100px" class="align-middle"></td>
                            <td style="width: 200px; text-align: left">
                                <div th:switch="${item.pSaleType}">
                                    판매유형:
                                    <span th:case="0">경매</span>
                                    <span th:case="1">즉시판매</span>
                                </div>
                            </td>
                            <td th:text="${item.productId}" rowspan="2" style="width: 80px" class="align-middle"></td>
                            <td th:if="${item.pSaleType == 0}" rowspan="2" style="width: 100px" class="align-middle">경매가 <br><span th:text="${item.pBPrice}"></span>원</td>
                            <td th:if="${item.pSaleType == 1}" rowspan="2" style="width: 100px" class="align-middle">즉시판매가 <br><span th:text="${item.pDirect}"></span>원</td>
                            <td th:text="${item.pCreatedAt}" rowspan="2" style="width: 100px" class="align-middle"></td>
                            <td rowspan="2" style="width: 80px" class="align-middle">
                                <div th:switch="${item.pSalesStatus}">
                                    <span th:case="0">판매승인전</span>
                                    <span th:case="1">판매중</span>
                                    <span th:case="2">판매완료</span>
                                    <span th:case="3">걍매낙찰</span>
                                    <span th:case="4">경매실패</span>
                                    <span th:case="5">판매보류</span>
                                </div>
                            </td>
<!--                            <td rowspan="2" style="width: 80px" class="align-middle">-->
<!--                                <button th:inline="javascript" th:onclick="'deleteItem(\''+${item.productId}+'\')'">삭제</button>-->
<!--                            </td>-->
                        </tr>
                        <tr>
                            <td th:text="${item.pName}" style="text-align: left"></td>
                        </tr>
                        </tbody>
                    </table>
                    <div th:if="${salesItems == null}" style="align-content: center">
                        판매내역이 없습니다.
                    </div>
                </div>
                <div th:if="${type.equals('basket')}" class="basket_list">
                    <div class="order_list_subtitle">
                        <h4>장바구니</h4>
                    </div>
                    <table th:if="${basketItems != null}" class="table table-hover mx-auto text-center" style="width: 1000px">
                        <thead>
                        <tr class="table-active">
                            <th>번호</th>
                            <th>image</th>
                            <th>상품ID</th>
                            <th>상품명</th>
                            <th>판매자</th>
                            <th>가격</th>
                            <th>관리</th>
                        </tr>
                        </thead>
                        <tbody class="text-center">
                        <!--            <tr th:each="item, count:${basketItems}" th:id="${item.product_id}" >-->
                        <tr th:if="${item.pSalesStatus==1}" th:id="${item.productId}" th:each="item, count:${basketItems}" class="item-show">
                            <td th:class="count" th:text="${count.count}"></td>
                            <td th:text="${item.iSubImg}"></td>
                            <td th:text="${item.productId}"></td>
                            <td th:text="${item.pName}"></td>
                            <td th:text="${item.uName}"></td>
                            <td class="price" th:text="${item.pDirect}"></td>
                            <td><button th:inline="javascript" th:onclick="'deleteItem(\''+${item.productId}+'\')'">삭제</button></td>
                        </tr>
                        <tr th:if="${item.pSalesStatus==2}" th:id="${item.productId}" th:each="item, count:${basketItems}" class="table-active">
                            <td>품절</td>
                            <td th:text="${item.iSubImg}"></td>
                            <td th:text="${item.productId}"></td>
                            <td th:text="${item.pName}"></td>
                            <td th:text="${item.uName}"></td>
                            <td th:text="${item.pDirect}"></td>
                            <td><button th:inline="javascript" th:onclick="'deleteItem(\''+${item.productId}+'\')'">삭제</button></td>
                        </tr>
                        </tbody>
                        <tfoot class="table-group-divider">
<!--                        <tr class="table-light">-->
                        <tr>
                            <td colspan="2" style="text-align: center">총 수량</td>
                            <td colspan="3" style="text-align: right">
                                <span id="total_amount"></span> 개
                            </td>
                            <td colspan="2"></td>
                        </tr>
                        <tr class="table-active">
                            <td colspan="2" style="text-align: center">총 금액</td>
                            <td colspan="3" style="text-align: right">
                                <span id="total_price"></span> 원
                            </td>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td style="text-align: center" colspan="7">
                                <button>결제하기</button>
                            </td>
                        </tr>
                        </tfoot>
                    </table>
                    <div th:if="${basketItems == null}" style="align-content: center">
                        장바구니가 비어있습니다.
                    </div>
                </div>
                <div th:if="${type.equals('wish')}" class="basket_list">
                    <div class="order_list_subtitle">
                        <h4>관심상품</h4>
                    </div>
                    <table class="table table-hover mx-auto text-center" style="width: 1000px">
                        <thead>
                        <tr class="table-active">
                            <td>번호</td>
                            <th colspan="2">상품정보</th>
                            <th>제품코드</th>
                            <th>금액</th>
                            <th>판매시작일</th>
                            <th>주문상태</th>
                        </tr>
                        </thead>
                        <tbody th:each="item, count:${salesItems}" th:id="${item.productId}" class="item-show">
                        <tr>
                            <td th:text="${count.count}" rowspan="2" style="width: 40px" class="align-middle"></td>
                            <td th:text="${item.iSubImg}" rowspan="2" style="width: 100px" class="align-middle"></td>
                            <td style="width: 200px; text-align: left">
                                <div th:switch="${item.pSaleType}">
                                    판매유형:
                                    <span th:case="0">경매</span>
                                    <span th:case="1">즉시판매</span>
                                </div>
                            </td>
                            <td th:text="${item.productId}" rowspan="2" style="width: 80px" class="align-middle"></td>
                            <td th:if="${item.pSaleType == 0}" rowspan="2" style="width: 100px" class="align-middle">경매가 <br><span th:text="${item.pBPrice}"></span>원</td>
                            <td th:if="${item.pSaleType == 1}" rowspan="2" style="width: 100px" class="align-middle">즉시판매가 <br><span th:text="${item.pDirect}"></span>원</td>
                            <td th:text="${item.pCreatedAt}" rowspan="2" style="width: 100px" class="align-middle"></td>
                            <td rowspan="2" style="width: 80px" class="align-middle">
                                <div th:switch="${item.pSalesStatus}">
                                    <span th:case="0">판매승인전</span>
                                    <span th:case="1">판매중</span>
                                    <span th:case="2">판매완료</span>
                                    <span th:case="3">걍매낙찰</span>
                                    <span th:case="4">경매실패</span>
                                    <span th:case="5">판매보류</span>
                                </div>
                            </td>
                            <!--                            <td rowspan="2" style="width: 80px" class="align-middle">-->
                            <!--                                <button th:inline="javascript" th:onclick="'deleteItem(\''+${item.productId}+'\')'">삭제</button>-->
                            <!--                            </td>-->
                        </tr>
                        <tr>
                            <td th:text="${item.pName}" style="text-align: left"></td>
                        </tr>
                        </tbody>
                    </table>
                    <div th:if="${basketItems == null}" style="align-content: center">
                        장바구니가 비어있습니다.
                    </div>
                </div>
                <div th:if="${type.equals('modify')}" class="basket_list">
                    <div class="order_list_subtitle">
                        <h4>나의 정보수정</h4>
                    </div>
                    <form name="frm_update" id="frm_update" class="table-primary" method="post" action="/mypage/joinProc">
                        <input th:if="${user}" type="hidden" name="uSocial" th:value="${user.uSocial}">
                        <!--    <input type="text" name="u_social" th:value="${user.getU_social()}">-->
                        <table align="center">
                            <tr height="60">
                                <td style="width: 100px">User ID</td>
                                <td>
                                    <input name="uId" id="uId" type="text" th:value="${user.uId}" size="20" readonly>
<!--                                    <button type="button" id="check_btn" onclick="sendRequest()">중복 체크</button>-->
<!--                                    <span id="check_result"></span>-->
<!--                                    <span class="fs-6 text-danger" th:text="${valid_uId}"></span>-->

                                </td>
                            </tr>
                            <tr height="60">
                                <td>암    호</td>
                                <td>
                                    <input name="uPassword" type="password" size="20">
                                    <div><span class="fs-6 text-danger" th:text="${valid_uPassword}"></span></div>
                                </td>
                            </tr>
                            <tr height="60">
                                <td>암호 확인</td>
                                <td>
                                    <input name="uPwdCheck" type="password" size="20">
                                    <div><span class="fs-6 text-danger" th:text="${valid_uPwdCheck}"></span></div>
                                </td>
                            </tr>
                            <tr height="60">
                                <td>이   름</td>
                                <td>
                                    <input name="uName" type="text" th:value="${user.uName}" size="20" readonly>
                                    <!--        <input name="u_name" type="text" size="20">*-->
                                    <div><span class="fs-6 text-danger" th:text="${valid_uName}"></span></div>
                                </td>
                            </tr>
                            <tr height="60">
                                <td>생년월일</td>
                                <td>
                                    <input name="uJumin" type="text" th:value="${user.uJumin}" size="20" placeholder="예) 960429" readonly>
                                    <div><span class="fs-6 text-danger" th:text="${valid_uJumin}"></span></div>
                                </td>
                            </tr>
                            <tr height="60">
                                <td>전화번호</td>
                                <td>
                                    <input name="uPhone" type="text" th:value="${user.uPhone}" size="20" placeholder="예) 01x-xxxx-xxxx">
                                    <div><span class="fs-6 text-danger" th:text="${valid_uPhone}"></span></div>
                                </td>
                            </tr>
                            <tr height="60">
                                <td>닉네임</td>
                                <td>
                                    <input name="uNickname" type="text" th:value="${user.uNickname}" size="20">
                                    <div><span class="fs-6 text-danger" th:text="${valid_uNickname}"></span></div>
                                </td>
                            </tr>
                            <tr height="60">
                                <td>E-mail</td>
                                <td>
                                    <input name="uEmail" type="text" th:value="${user.uEmail}" size="60">
                                    <div><span class="fs-6 text-danger" th:text="${valid_uEmail}"></span></div>
                                </td>
                            </tr>
                            <tr height="60">
                                <td>주    소</td>
                                <td>
                                    <input name="uAddrPostcode" id="uAddrPostcode" type="text" th:value="${user.uAddrPostcode}" size="10" readonly placeholder="우편번호"> <br>
                                    <input name="uAddress" id="uAddress" type="text" th:value="${user.uAddress}" size="40" readonly>
                                    <input type="button"  value="주소검색" onclick="goPopup();"> <br>
                                    <input name="uAddressSub" id="uAddressSub" type="text" th:value="${user.uAddressSub}" size="20" placeholder="상세 주소">
                                    <div><span class="fs-6 text-danger" th:text="${valid_uAddress}"></span> <br></div>
                                </td>
                            </tr>
                            <tr height="60">
                                <td colspan="2" align="center">
<!--                                    <button onclick="updateUser()">수정</button>-->
                                    <input type="submit" id="insert_mem" value="수정">
                                    <input type="reset" value="다시입력">
                                    <input type="button" value="취소" onclick="javascript:window.location='/mypage/mypage_page'">
                                </td>
                            </tr>
                        </table>
                    </form>
                </div>
            </div>
        </main>
    </div>
    <form method="post" action="#" id="frm_show_item">
        <input type="hidden" id="productId" value="">
    </form>
    <div class="bottom_fragment">
        <th:block th:replace="fragments/footer"></th:block>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
</body>
</html>
<script>
    // function deleteItem(itemId){
    //     console.log("delete: "+itemId);
    //     $.ajax({
    //         url:'/basket/deleteItem',
    //         type:'POST',
    //         data:{
    //             'product_id':itemId
    //         },
    //         success:function(result){
    //             console.log("success");
    //             if(result == 'success'){
    //                 alert('삭제성공');
    //                 $('#'+itemId).remove();
    //             }else{
    //                 alert('오류');
    //             }
    //         },
    //         error: function (result){
    //             alert('삭제실패');
    //         }
    //     });
    // }
    $(".item-show").on('click',function (){
        var productId = $(this).attr('id');
        $("#productId").val(productId);
        $("#frm_show_item").submit();
    })
    var result_modify = $("#result_modify").val();
    if(result_modify == 'success'){
        alert("수정 완료.");
        location.href="/mypage/mypage_page";
    }
    $(function (){
        var totalPrice = 0;
        $('.price').each(function (){
            var priceVal = parseInt($(this).text());
            totalPrice += priceVal;
        });
        $('#total_price').text(totalPrice);
        console.log("totalPrice : "+totalPrice);

        var count = 0;
        $('.count').each(function (){
            count += 1;
        });
        $('#total_amount').text(count);

    });

    function deleteItem(itemId){
        console.log("delete: "+itemId);
        $.ajax({
            url:'/basket/deleteItem',
            type:'POST',
            data:{
                'product_id':itemId
            },
            success:function(result){
                console.log("success");
                if(result == 'success'){
                    alert('삭제성공');
                    $('#'+itemId).remove();
                }else{
                    alert('오류');
                }
            },
            error: function (result){
                alert('삭제실패');
            }
        });
    }

    function updateUser(){
        var update_frm = $('#frm_update').serialize();
        $.ajax({
            url: '/mypage/joinProc',
            type: 'POST',
            data:update_frm,
            success:function (response){
                if(response=='success'){
                    alert("수정 완료.");
                    location.href='/mypage/mypage_page';
                }else{
                    alert("수정 실패. \n잠시 후 다시 시도해주세요.");
                }
            },
            error:function (response){
                alert(response);
            }
        });
    }

</script>