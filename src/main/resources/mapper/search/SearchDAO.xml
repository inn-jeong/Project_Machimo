<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.project_machimo.search.dao.SearchDAO">
    <select id="searchUser" resultType="com.example.project_machimo.search.dto.SearchVO">
        SELECT p.PRODUCTS_ID as products_id, u.USER_ID as user_id, u.U_NICKNAME as u_nickname
        ,i.i_ID as i_id, MIN(i.I_IMAGE) AS i_image,MIN(i.i_sub_img) as i_sub_img
        ,p.P_NAME as p_name , p.P_INFO as p_info
        FROM USERS U
        JOIN PRODUCTS P ON U.USER_ID = P.USER_ID
        LEFT JOIN (
        SELECT PRODUCT_ID,I_ID,MIN(I_IMAGE) AS I_IMAGE ,MIN(i_sub_img) as i_sub_img , p.P_NAME as p_name,p.P_INFO as
        p_info
        FROM PRODUCT_IMAGES i join PRODUCTS p on p.PRODUCTS_ID = i.PRODUCT_ID
        GROUP BY PRODUCT_ID,I_ID,P_NAME,P_INFO
        ) i ON P.PRODUCTS_ID = i.PRODUCT_ID
        WHERE u.U_NICKNAME LIKE '%'||#{keyword}||'%'
        GROUP BY p.PRODUCTS_ID, u.USER_ID, u.U_NICKNAME, i.i_ID,p.P_NAME,p.P_INFO
        ORDER BY u.USER_ID
    </select>
    <select id="searchProductName" resultType="com.example.project_machimo.search.dto.SearchVO">

        SELECT p.PRODUCTS_ID as products_id, u.USER_ID as user_id, u.U_NICKNAME as u_nickname
        ,i.i_ID as i_id, MIN(i.I_IMAGE) AS i_image,MIN(i.i_sub_img) as i_sub_img
        ,p.P_NAME as p_name , p.P_INFO as p_info
        FROM USERS U
        JOIN PRODUCTS P ON U.USER_ID = P.USER_ID
        LEFT JOIN (
        SELECT PRODUCT_ID,I_ID,MIN(I_IMAGE) AS I_IMAGE ,MIN(i_sub_img) as i_sub_img , p.P_NAME as p_name,p.P_INFO as
        p_info
        FROM PRODUCT_IMAGES i join PRODUCTS p on p.PRODUCTS_ID = i.PRODUCT_ID
        GROUP BY PRODUCT_ID,I_ID,P_NAME,P_INFO
        ) i ON P.PRODUCTS_ID = i.PRODUCT_ID
        WHERE p.P_NAME LIKE '%'||#{keyword}||'%'
        GROUP BY p.PRODUCTS_ID, u.USER_ID, u.U_NICKNAME, i.i_ID,p.P_NAME,p.P_INFO
        ORDER BY u.USER_ID

    </select>
    <select id="searchProductInfo" resultType="com.example.project_machimo.search.dto.SearchVO">
        SELECT p.PRODUCTS_ID as products_id, u.USER_ID as user_id, u.U_NICKNAME as u_nickname
        ,i.i_ID as i_id, MIN(i.I_IMAGE) AS i_image,MIN(i.i_sub_img) as i_sub_img
        ,p.P_NAME as p_name , p.P_INFO as p_info
        FROM USERS U
        JOIN PRODUCTS P ON U.USER_ID = P.USER_ID
        LEFT JOIN (
        SELECT PRODUCT_ID,I_ID,MIN(I_IMAGE) AS I_IMAGE ,MIN(i_sub_img) as i_sub_img , p.P_NAME as p_name,p.P_INFO as
        p_info
        FROM PRODUCT_IMAGES i join PRODUCTS p on p.PRODUCTS_ID = i.PRODUCT_ID
        GROUP BY PRODUCT_ID,I_ID,P_NAME,P_INFO
        ) i ON P.PRODUCTS_ID = i.PRODUCT_ID
        WHERE p.P_INFO LIKE '%'||#{keyword}||'%'
        GROUP BY p.PRODUCTS_ID, u.USER_ID, u.U_NICKNAME, i.i_ID,p.P_NAME,p.P_INFO
        ORDER BY u.USER_ID
    </select>
    <select id="searchProductNameOrInfo" resultType="com.example.project_machimo.search.dto.SearchVO">
SELECT *
FROM (
    SELECT
        p.PRODUCTS_ID as products_id,
        u.USER_ID as user_id,
        u.U_NICKNAME as u_nickname,
        i.i_ID as i_id,
        i.I_IMAGE as i_image,
        i.i_sub_img as i_sub_img,
        p.P_NAME as p_name,
        p.P_INFO as p_info
    FROM USERS U
    JOIN PRODUCTS P ON U.USER_ID = P.USER_ID
    LEFT JOIN (
        SELECT PRODUCT_ID, I_ID, MIN(I_IMAGE) AS I_IMAGE, MIN(i_sub_img) as i_sub_img
        FROM PRODUCT_IMAGES
        GROUP BY PRODUCT_ID, I_ID
    ) i ON P.PRODUCTS_ID = i.PRODUCT_ID
    WHERE p.P_NAME LIKE '%'||#{keyword}||'%' or p.P_INFO like '%'||#{keyword}||'%'
    ORDER BY p.P_CREATED_AT
)
WHERE ROWNUM <![CDATA[<=]]> 10
    </select>
    <select id="getListWithPaging" resultType="com.example.project_machimo.search.dto.SearchVO">
        <![CDATA[
SELECT *
FROM (
    SELECT
        p.PRODUCTS_ID as products_id,
        u.USER_ID as user_id,
        u.U_NICKNAME as u_nickname,
        i.i_ID as i_id,
        i.I_IMAGE as i_image,
        i.i_sub_img as i_sub_img,
        p.P_NAME as p_name,
        p.P_INFO as p_info,
        ROW_NUMBER() OVER (ORDER BY p.P_CREATED_AT) rn
    FROM USERS U
    JOIN PRODUCTS P ON U.USER_ID = P.USER_ID
    LEFT JOIN (
        SELECT PRODUCT_ID, I_ID, MIN(I_IMAGE) AS I_IMAGE, MIN(i_sub_img) as i_sub_img
        FROM PRODUCT_IMAGES
        GROUP BY PRODUCT_ID, I_ID
    ) i ON P.PRODUCTS_ID = i.PRODUCT_ID
    WHERE p.P_NAME LIKE '%'||#{keyword}||'%'
-->
)
WHERE rn > (#{cri.pageNum}-1) * 10 and rownum <= #{cri.pageNum}*#{cri.amount}
        ]]>
        <!--    WHERE p.P_NAME LIKE '%'||#{keyword}||'%' and p.PRODUCTS_ID > 0 and ROWNUM > 0 and rownum <= (#{cri.pageNum}*#{cri.amount}) -->
    </select>
    <select id="searchUsersTotal" resultType="java.lang.Integer">
        select count(*) from PRODUCTS
        where P_NAME like '%'||#{keyword}||'%'
    </select>


</mapper>
