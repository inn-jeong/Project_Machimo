<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마취모: 마이페이지</title>
    <script type="text/javascript" src="/login/jquery.min.js" ></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
        .top_fragment,.bottom_fragment{
            display: block;
        }
        #wrapper{
            position:relative;
            min-width: 1200px;
        }
        #cnt{
            min-height: 1000px;
            position: relative;
        }
        #cnt .cnt_body{
            position: relative;
            padding-left: 320px;
            width: 1200px;
            margin: 0 auto;
        }
        h2.subtitle {
            padding: 30px 0 20px;
            font-size: 35px;
            font-weight: normal;
            text-align: center;
        }
        .my_menu{
            position: absolute;
            top: 0;
            width: 260px;
            margin-left: -320px;
        }
        .username{
            color: #fff;
            line-height: 1;
        }
        .username strong{
            font-size: 34px;
            font-weight: 500;
        }
        .usertitle{
            color: rgb(255,102,35) !important;
        }
        .order_list_subtitle{
            padding: 60px 0 20px 30px;
        }
        dl{
            padding-left: 20px;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <div class="top_fragment">
        <th:block th:replace="fragments/header"></th:block>
    </div>
    <div id="cnt">
        <header>
            <!--        <div class="mb-5 text-center">-->
            <!--            <h3>마이페이지</h3>-->
            <!--        </div>-->
            <h2 class="subtitle">마이페이지</h2>
        </header>

        <main>
            <div class="cnt_body">
                <div class="my_menu border">
                    <div class="mb-4 bg-dark py-5 text-center">
                        <h2 class="usertitle mb-3">프로필 정보</h2>
                        <p class="username"><strong><span id="name" th:text="${session.user.uName}"></span></strong>님</p>
                        <!--                <p class="username">이름: <strong><span id="name" th:text="${session.user.uName}"></span></strong>님</p>-->
                        <!--                <p class="username">이메일: <strong><span id="email" th:text="${session.user.uEmail}"></span></strong></p>-->
                    </div>

                    <dl>
                        <dt>정보관리</dt>
                        <dd>나의 정보수정</dd>
                        <dd>회원탈퇴</dd>
                    </dl>
                    <dl>
                        <dt>상품관리</dt>
                        <dd><a href="/basket/page">장바구니</a></dd>
                        <dd>관심상품</dd>
                        <dd><a href="/mypage/sales_list">판매내역</a></dd>
                    </dl>
                    <dl>
                        <dt>주문관리</dt>
                        <dd><a href="/mypage/order_list">주문내역</a></dd>
                        <dd>낙찰상품</dd>
                    </dl>
                    <dl class="pb-5">
                        <dt>활동관리</dt>
                        <dd>나의 문의내역</dd>
                        <dd>나의 상품후기</dd>
                    </dl>
                </div>
                <div th:if="${type.equals('main')}" class="order_list">
                    <div class="order_list_subtitle">
                        <h4>최근 구매 내역</h4>
                    </div>
                    <table class="table table-hover mx-auto text-center" style="width: 1000px">
                        <thead>
                        <tr class="table-active">
                            <td>번호</td>
                            <th colspan="2">상품정보</th>
                            <th >주문일자</th>
                            <th>주문번호</th>
                            <th>주문금액</th>
                            <th colspan="2">주문상태</th>
                        </tr>
                        </thead>
                        <tbody th:each="item, count:${items}" th:id="${item.productId}" class="item-show">
                        <tr>
                            <td th:text="${count.count}" rowspan="2" style="width: 40px" class="align-middle"></td>
                            <td th:text="${item.iSubImg}" rowspan="2" style="width: 100px" class="align-middle"></td>
                            <td th:text="${item.uName}" style="width: 200px; text-align: left"></td>
                            <td th:text="${item.createdAt}" rowspan="2" style="width: 120px" class="align-middle"></td>
                            <td th:text="${item.orderId}" rowspan="2" style="width: 80px" class="align-middle"></td>
                            <td th:text="${item.pDirect}+원" rowspan="2" style="width: 100px" class="align-middle"></td>
                            <td th:text="${item.orderStatus}" rowspan="2" style="width: 80px" class="align-middle"></td>
                            <td rowspan="2" style="width: 80px" class="align-middle"><button>후기작성</button></td>
                        </tr>
                        <tr>
                            <td th:text="${item.pName}" style="text-align: left"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${type.equals('order')}" class="order_list">
                    <div class="order_list_subtitle">
                        <h4>구매 내역</h4>
                    </div>
                    <table class="table table-hover mx-auto text-center" style="width: 1000px">
                        <thead>
                        <tr class="table-active">
                            <td>번호</td>
                            <th colspan="2">상품정보</th>
                            <th >주문일자</th>
                            <th>주문번호</th>
                            <th>주문금액</th>
                            <th colspan="2">주문상태</th>
                        </tr>
                        </thead>
                        <tbody th:each="item, count:${items}" th:id="${item.productId}" class="item-show">
                        <tr>
                            <td th:text="${count.count}" rowspan="2" style="width: 40px" class="align-middle"></td>
                            <td th:text="${item.iSubImg}" rowspan="2" style="width: 100px" class="align-middle"></td>
                            <td th:text="${item.uName}" style="width: 200px; text-align: left"></td>
                            <td th:text="${item.createdAt}" rowspan="2" style="width: 120px" class="align-middle"></td>
                            <td th:text="${item.orderId}" rowspan="2" style="width: 80px" class="align-middle"></td>
                            <td th:text="${item.pDirect}+원" rowspan="2" style="width: 100px" class="align-middle"></td>
                            <td th:text="${item.orderStatus}" rowspan="2" style="width: 80px" class="align-middle"></td>
                            <td rowspan="2" style="width: 80px" class="align-middle"><button>후기작성</button></td>
                        </tr>
                        <tr>
                            <td th:text="${item.pName}" style="text-align: left"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${type.equals('sales')}" class="order_list">
                    <div class="order_list_subtitle">
                        <h4>판매 내역</h4>
                    </div>
                    <table class="table table-hover mx-auto text-center" style="width: 1000px">
                        <thead>
                        <tr class="table-active">
                            <td>번호</td>
                            <th colspan="2">상품정보</th>
                            <th>제품코드</th>
                            <th>금액</th>
                            <th>판매시작일</th>
                            <th>주문상태</th>
                        </tr>
                        </thead>
                        <tbody th:each="item, count:${salesItems}" th:id="${item.productId}" class="item-show">
                        <tr>
                            <td th:text="${count.count}" rowspan="2" style="width: 40px" class="align-middle"></td>
                            <td th:text="${item.iSubImg}" rowspan="2" style="width: 100px" class="align-middle"></td>
                            <td style="width: 200px; text-align: left">
                                <div th:switch="${item.pSaleType}">
                                    판매유형:
                                    <span th:case="0">경매</span>
                                    <span th:case="1">즉시판매</span>
                                </div>
                            </td>
                            <td th:text="${item.productId}" rowspan="2" style="width: 80px" class="align-middle"></td>
                            <td th:if="${item.pSaleType == 0}" rowspan="2" style="width: 100px" class="align-middle">경매가 <br><span th:text="${item.pBPrice}"></span>원</td>
                            <td th:if="${item.pSaleType == 1}" rowspan="2" style="width: 100px" class="align-middle">즉시판매가 <br><span th:text="${item.pDirect}"></span>원</td>
                            <td th:text="${item.pCreatedAt}" rowspan="2" style="width: 100px" class="align-middle"></td>
                            <td rowspan="2" style="width: 80px" class="align-middle">
                                <div th:switch="${item.pSalesStatus}">
                                    <span th:case="0">판매승인전</span>
                                    <span th:case="1">판매중</span>
                                    <span th:case="2">판매완료</span>
                                    <span th:case="3">걍매낙찰</span>
                                    <span th:case="4">경매실패</span>
                                    <span th:case="5">판매보류</span>
                                </div>
                            </td>
<!--                            <td rowspan="2" style="width: 80px" class="align-middle">-->
<!--                                <button th:inline="javascript" th:onclick="'deleteItem(\''+${item.productId}+'\')'">삭제</button>-->
<!--                            </td>-->
                        </tr>
                        <tr>
                            <td th:text="${item.pName}" style="text-align: left"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${type.equals('basket')}" class="basket_list">
                    <div class="order_list_subtitle">
                        <h4>장바구니</h4>
                    </div>
                    <table th:if="${basketItems != null}" class="table table-hover mx-auto text-center">
                        <thead>
                        <tr class="table-active">
                            <th>번호</th>
                            <th>image</th>
                            <th>상품ID</th>
                            <th>상품명</th>
                            <th>판매자</th>
                            <th>가격</th>
                            <th>삭제</th>
                        </tr>
                        </thead>
                        <tbody class="text-center">
                        <!--            <tr th:each="item, count:${basketItems}" th:id="${item.product_id}" >-->
                        <tr th:if="${item.pSalesStatus==1}" th:id="${item.productId}" th:each="item, count:${basketItems}" class="item-show">
                            <td th:class="count" th:text="${count.count}"></td>
                            <td th:text="${item.iSubImg}"></td>
                            <td th:text="${item.productId}"></td>
                            <td th:text="${item.pName}"></td>
                            <td th:text="${item.uName}"></td>
                            <td class="price" th:text="${item.pDirect}"></td>
                            <td><button th:inline="javascript" th:onclick="'deleteItem(\''+${item.productId}+'\')'">삭제</button></td>
                        </tr>
                        <tr th:if="${item.pSalesStatus==2}" th:id="${item.productId}" th:each="item, count:${basketItems}" class="table-active">
                            <td>품절</td>
                            <td th:text="${item.iSubImg}"></td>
                            <td th:text="${item.productId}"></td>
                            <td th:text="${item.pName}"></td>
                            <td th:text="${item.uName}"></td>
                            <td th:text="${item.pDirect}"></td>
                            <td><button th:inline="javascript" th:onclick="'deleteItem(\''+${item.productId}+'\')'">삭제</button></td>
                        </tr>
                        </tbody>
                        <tfoot class="table-group-divider">
<!--                        <tr class="table-light">-->
                        <tr>
                            <td colspan="2" style="text-align: center">총 수량</td>
                            <td colspan="3" style="text-align: right">
                                <span id="total_amount"></span> 개
                            </td>
                            <td colspan="2"></td>
                        </tr>
                        <tr class="table-active">
                            <td colspan="2" style="text-align: center">총 금액</td>
                            <td colspan="3" style="text-align: right">
                                <span id="total_price"></span> 원
                            </td>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td style="text-align: center" colspan="7">
                                <button>결제하기</button>
                            </td>
                        </tr>
                        </tfoot>
                    </table>
                    <div th:if="${basketItems == null}" style="align-content: center">
                        장바구니가 비어있습니다.
                    </div>
                    </table>
                </div>
            </div>
        </main>
    </div>
    <form method="post" action="#" id="frm_show_item">
        <input type="hidden" id="productId" value="">
    </form>
    <div class="bottom_fragment">
        <th:block th:replace="fragments/footer"></th:block>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
</body>
</html>
<script>
    // function deleteItem(itemId){
    //     console.log("delete: "+itemId);
    //     $.ajax({
    //         url:'/basket/deleteItem',
    //         type:'POST',
    //         data:{
    //             'product_id':itemId
    //         },
    //         success:function(result){
    //             console.log("success");
    //             if(result == 'success'){
    //                 alert('삭제성공');
    //                 $('#'+itemId).remove();
    //             }else{
    //                 alert('오류');
    //             }
    //         },
    //         error: function (result){
    //             alert('삭제실패');
    //         }
    //     });
    // }
    $(".item-show").on('click',function (){
        var productId = $(this).attr('id');
        $("#productId").val(productId);
        $("#frm_show_item").submit();
    })
    $(function (){
        var totalPrice = 0;
        $('.price').each(function (){
            var priceVal = parseInt($(this).text());
            totalPrice += priceVal;
        });
        $('#total_price').text(totalPrice);
        console.log("totalPrice : "+totalPrice);

        var count = 0;
        $('.count').each(function (){
            count += 1;
        });
        $('#total_amount').text(count);

    });

    function deleteItem(itemId){
        console.log("delete: "+itemId);
        $.ajax({
            url:'/basket/deleteItem',
            type:'POST',
            data:{
                'product_id':itemId
            },
            success:function(result){
                console.log("success");
                if(result == 'success'){
                    alert('삭제성공');
                    $('#'+itemId).remove();
                }else{
                    alert('오류');
                }
            },
            error: function (result){
                alert('삭제실패');
            }
        });
    }

</script>